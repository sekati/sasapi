/** * com.sekati.display.BitmapImageClip * @version 1.0.0 * @author jason m horwitz | sekati.com | tendercreative.com * Copyright (C) 2007  jason m horwitz, Sekat LLC. All Rights Reserved. * Released under the MIT License: http://www.opensource.org/licenses/mit-license.php */  import com.sekati.display.BaseClip; import com.sekati.utils.Delegate; import com.sekati.utils.MovieClipUtils; import com.sekati.except.FatalException; import flash.display.BitmapData;/** * BitmapImageClip - load an image, convert it to a smoothed BitmapData object available for manipulation. * {@code Usage: * 	import com.sekati.utils.* * 	import caurina.transitions.Tweener; * 	 * 	function _onProgress(l:Number, t:Number):Void { trace("img_onProgress: "+l+" / "+t); } * 	function  _onInit():Void { Tweener.addTween(image, {_alpha:100, time:0.3, transition:"easeInOutQuint"}); } * 	 * 	// create an empty BitmapImageClip * 	var image:MovieClip =  ClassUtils.createEmptyMovieClip (com.sekati.display.BitmapImageClip, this, "image", {_x:0, _y:0}); * 	 * 	// load an image and define onProgress onInit Delegates. * 	image.load("test.jpg", Delegate.create(this, _onProgress), Delegate.create(this, _onInit)); * } */class com.sekati.display.BitmapImageClip extends BaseClip {		private var _uri:String;	private var _progressCb:Function;	private var _initCb:Function;	private var _loader:MovieClipLoader;	private var _tmp:MovieClip;	public var img:MovieClip;	public var bmp:BitmapData;		/**	 * Constructor	 */	public function BitmapImageClip() {		super();		_loader = new MovieClipLoader();		_this.onLoadInit = Delegate.create(_this, _onInit);		_this.onLoadError = Delegate.create(_this, _onError);		_this.onLoadProgress = Delegate.create(_this, _onProgress);		_loader.addListener(_this);	}		/**	 * Load image and convert to bitmap	 * @param uri (String)	 * @param onProgress (Function) - cb is passed args: bytesLoaded, bytesTotal.	 * @param onInit (Function)	 * @return Void	 */	public function load(uri:String, onProgress:Function, onInit:Function):Void {		_uri = uri;		_progressCb = onProgress;		_initCb = onInit;		createContainers();		_loader.loadClip(_uri, _tmp);		}		/**	 * Remove the bitmap and clips.	 */	public function unload():Void {		_loader.unloadClip(img);		bmp.dispose();		MovieClipUtils.rmClip(_tmp); 		MovieClipUtils.rmClip(img);	}	/**	 * Create the temporary image Container	 */	private function createContainers():Void {		if (_tmp) MovieClipUtils.rmClip(_tmp); 		if (img) MovieClipUtils.rmClip(img);		if (bmp) bmp.dispose();		img = _this.createEmptyMovieClip("img", _this.getNextHighestDepth());		_tmp = _this.createEmptyMovieClip("_tmp", _this.getNextHighestDepth());		img.cacheAsBitmap = true;		_tmp._visible = false;		_this._alpha = 0;	}		/**	 * Once external image is loaded, convert to smoothed bitmapData object	 * and run the {@link _initCb} if it was defined during {@link load}.	 */	private function _onInit():Void {		bmp = new BitmapData(_tmp._width, _tmp._height,true, 0x00FFFFFF);		bmp.draw(_tmp);		img.attachBitmap(bmp, img.getNextHighestDepth(), "auto", true);		MovieClipUtils.rmClip(_tmp);		_initCb();		_initCb = undefined;	}	private function _onProgress(target:MovieClip, bytesLoaded:Number, bytesTotal:Number):Void {		trace("loading: "+target + " " + bytesLoaded + "/" + bytesTotal);		_progressCb(bytesLoaded, bytesTotal);	}	private function _onError():Void {		throw new FatalException(this, "Could not load image from url:"+_uri, arguments);	}	}